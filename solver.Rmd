---
title: "Casino floor mix optimization"
author: "Andreose E, Caldara G, Comotto F, Scardovelli M"
output: html_notebook
---

Import libraries and dataset
```{r}
library(tidyverse)
library(lubridate)
library(caret)
library(linprog)
options(scipen = 999)
slot <- readxl::read_excel("data/Lucky Duck Entertainment revenue 2013.xls", na = c(".", "NA", "NaN"))
str(slot)
```

Create dataset to be used for further analysis, i.e. aggregate slots by categories (MachineType+Denomination) for each month and section in each casino.
```{r}
df <- slot %>%
  group_by(Casino, Month, Section, MachineType, Denomination) %>%
  summarise(numero_macchine    = sum(NoMachines),
            ricavi_totali      = sum(GrossRevenue),
            ricavo_unitario    = ricavi_totali/numero_macchine,
            giocate_totali     = sum(Plays),
            giocate_unitarie   = round(giocate_totali/numero_macchine),
            ricavo_per_giocata = ricavi_totali/giocate_totali) %>%
  arrange(Month, Section, MachineType, Denomination) %>%
  mutate(tipo = paste0(MachineType, "_", Denomination)) 
head(df)
```

Temporary: remove the month of September
```{r}
df <- filter(df, Month != ymd("2011-09-01"))
```

Definition of the objective function using profit coefficients
```{r}
f.obj <- round(df$ricavo_unitario)
```

Costruzione dei vincoli
Primo vincolo: numero massimo di slot per ogni casino e ogni mese. 
```{r}
#Ottieni numero di slot presenti in ogni casino per mese da usare come upper bound
nslots <- df %>%
  group_by(Casino, Month) %>%
  summarise(max = sum(numero_macchine)) %>%
  arrange(Month)
nslots <- t(nslots$max)[1,] #numero di slot per casino e mese
#First create dummy var for Casino and month, used to activate each constraint depending on the casino and month
f.A1 <- t(predict(dummyVars(~ Casino : factor(Month), data = df), newdata = df))
#View(rbind(t(df[, "Casino"]), t(df$Month), f.A)) #Check results


#Coefficients
f.b1 <- nslots # vector of right-hand side values - upper bounds of total number of slots per month
f.dir1 <- rep("<=", length(f.b)) # direction of the inequalities

sol1 <- solveLP(f.obj, f.b1, f.A1, maximum = TRUE, const.dir = f.dir1) #solver 
sol1bis <- lp(direction = "max", objective.in = f.obj, const.mat = f.A1, const.dir = f.dir1, const.rhs = f.b1)

sol1$con
```

Secondo vincolo: la proporzione del tipo (MachineType+Denomination) di slot all'interno di ciascuna sezione dev'essere rispettato per ogni mese. Ovvero, non ci puo' essere un numero di slot di una categoria estremamente alto, ma deve rispettare dei vincoli 'di proporzione'.
Questo vincolo include il fatto che non ci possano essere sezioni vuote.
Vincolo 2
```{r}
f.A2 <- t(predict(dummyVars(~ Section : Casino : factor(Month), data = df), newdata = df))
# Duplicate every row, needed because for each section/month/casino we need a lower and upper bound. 
# Retain order --> ob1-low, obs1-up, obs2-low, ...)
f.A2 <- as.tibble(f.A2) %>% slice(rep(1:n(), each = 2)) %>% as.matrix()

#I vincoli sono attivati nel seguente modo 
# mese1-casino1-sez1-low,
# mese1-casino1-sez1-up,
# mese1-casino1-sez2;
# mese1-casino2;
# mese2;...
# quindi i primi 8 (4 sez * 2 up/low) vincoli sono associato ad un medesimo upper e lower bound, legato al primo valore di nslots.

# probabilmente si puo' fare senza il ciclo for, ma come??
#nslots contiene il numero di slot per ogni casino e mese, alternato per casino (mese1 casino1, mese1 casino2, mese2 casino1, ...)
f.b2 <- c()
for (n in nslots) {
  f.b2 <- c(f.b2, rep(round(c(n*.2, n*.3)), 4) )
}
f.dir2 <- rep(c(">=", "<="), length(f.b2)/2) # direction of the inequalities

sol2 <- solveLP(f.obj, f.b2, f.A2, maximum = TRUE, const.dir = f.dir2) #solver 
sol2bis <- lp(direction = "max", objective.in = f.obj, const.mat = f.A2, const.dir = f.dir2, const.rhs = f.b2)

sol2$con
```

Unisci vincoli
```{r}
f.A <- rbind(f.A1, f.A2)
f.b <- c(f.b1, f.b2)
f.dir <- c(f.dir1, f.dir2)

sol <- solveLP(f.obj, f.b, f.A, maximum = TRUE, const.dir = f.dir) #solver 
sol2bis <- lp(direction = "max", objective.in = f.obj, const.mat = f.A, const.dir = f.dir, const.rhs = f.b)

sol$con
```

